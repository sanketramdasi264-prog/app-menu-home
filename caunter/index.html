<!DOCTYPE html>
<html lang="mr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Premium Rudraksha Mala</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root {
    --bg-maroon: #2d0202;
    --gold-yellow: #FFD700;
    --card-bg: rgba(255, 255, 255, 0.05);
}

* { box-sizing: border-box; }

body, html {
    margin: 0; padding: 0;
    width: 100%; height: 100%;
    font-family: 'Poppins', sans-serif;
    background: linear-gradient(135deg, #4A0404 0%, #1a0000 100%);
    color: #ffffff;
    overflow: hidden;
    user-select: none;
}

.app-container {
    max-width: 450px;
    margin: 0 auto;
    height: 100vh;
    display: flex;
    flex-direction: column;
    padding: 15px;
    position: relative;
}

/* --- Header --- */
.header-capsules {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-bottom: 10px;
}
.capsule-btn {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    background: rgba(45, 2, 2, 0.8);
    border: 1px solid var(--gold-yellow);
    padding: 8px 20px;
    border-radius: 25px;
    font-size: 14px;
    font-weight: 700;
    cursor: pointer;
    color: var(--gold-yellow);
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}
.capsule-btn:active { transform: scale(0.95); }

/* --- Saved Japs Slider (No Counts) --- */
.saved-japs-section {
    padding: 5px 0;
    margin-bottom: 10px;
}
.jap-chip-container {
    display: flex;
    flex-wrap: nowrap;
    overflow-x: auto;
    gap: 10px;
    padding: 0 5px;
    align-items: center;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none; 
}
.jap-chip-container::-webkit-scrollbar { display: none; }

.jap-chip {
    flex: 0 0 auto;
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 215, 0, 0.3);
    padding: 8px 15px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    color: #ddd;
    transition: all 0.2s;
}
.jap-chip.active {
    background: var(--gold-yellow);
    color: #000;
    font-weight: 800;
    border-color: var(--gold-yellow);
    box-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
}
.delete-chip {
    background: rgba(255, 0, 0, 0.2);
    border: none;
    color: inherit;
    font-size: 14px;
    width: 20px; height: 20px;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    margin-left: 2px;
}
.add-jap-btn {
    flex: 0 0 auto;
    width: 35px; height: 35px;
    border-radius: 50%;
    background: rgba(255, 215, 0, 0.1);
    border: 1px solid var(--gold-yellow);
    color: var(--gold-yellow);
    font-size: 20px; font-weight: 900;
    display: flex; align-items: center; justify-content: center;
}

/* Add Input */
.add-jap-box { display: flex; gap: 6px; margin-bottom: 10px; }
.add-jap-box input {
    flex: 1; padding: 10px; border-radius: 10px; border: none; font-weight: 600; outline: none; font-size: 14px;
}
.add-jap-box.hidden { display: none; }
.save-btn {
    background: var(--gold-yellow); color: #000; border: none; padding: 0 15px; border-radius: 8px; font-weight: 800;
}

/* --- Highlighted Tip Box --- */
.tip-box {
    background: linear-gradient(135deg, #FFD700, #FFA500);
    color: #000;
    padding: 12px;
    border-radius: 10px;
    margin-bottom: 10px;
    text-align: center;
    font-size: 13px;
    font-weight: 800;
    box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
    animation: gentlePulse 2s infinite;
    border: 2px solid #fff;
}
@keyframes gentlePulse {
    0% { transform: scale(1); box-shadow: 0 0 10px rgba(255, 215, 0, 0.3); }
    50% { transform: scale(1.02); box-shadow: 0 0 20px rgba(255, 215, 0, 0.6); }
    100% { transform: scale(1); box-shadow: 0 0 10px rgba(255, 215, 0, 0.3); }
}

/* --- Mala Display --- */
.display-area {
    position: relative; 
    flex: 1; 
    display: flex; 
    justify-content: center; 
    align-items: center;
    min-height: 280px;
}
.mala-circle {
    position: relative; 
    width: 280px; height: 280px; 
    display: flex; justify-content: center; align-items: center;
}
#mala-beads { 
    position: absolute; width: 100%; height: 100%; transform: rotate(-90deg); 
}
.bead { 
    position: absolute; 
    width: 10px; height: 10px; 
    background: rgba(255,255,255,0.2); 
    border-radius: 50%; 
    transition: all 0.2s ease;
}
.bead.active { 
    background: var(--gold-yellow); 
    box-shadow: 0 0 10px var(--gold-yellow); 
    transform: scale(1.4);
}

.counter-box {
    width: 160px; height: 160px; 
    background: radial-gradient(circle, #FFD700, #FFA500);
    border-radius: 50%;
    display: flex; flex-direction: column; 
    justify-content: center; align-items: center;
    box-shadow: 0 0 50px rgba(255, 165, 0, 0.4); 
    z-index: 5; 
    border: 4px solid #fff;
}
#currentCount { font-size: 65px; font-weight: 900; color: #000; line-height: 1; }
#currentCount.animate { animation: countPop 0.2s ease; }
@keyframes countPop { 50% { transform: scale(1.15); } }

#currentNaamDisplay { 
    font-size: 14px; color: #4A0404; font-weight: 800;
    max-width: 130px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: center;
}

/* --- Stats Box --- */
.mala-stats {
    display: flex; 
    justify-content: space-between; 
    background: rgba(0,0,0,0.4); 
    padding: 15px 5px; 
    border-radius: 15px; 
    margin-bottom: 15px;
    border: 1px solid rgba(255,255,255,0.1);
}
.stat-item { 
    text-align: center; flex: 1; overflow: hidden; padding: 0 2px;
}
.stat-item span:first-child {
    display: block; font-size: 11px; opacity: 0.8; margin-bottom: 2px;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%;
}
.stat-v { 
    display: block; font-size: 18px; font-weight: 800; color: var(--gold-yellow);
}

/* --- Bottom Controls --- */
.bottom-controls {
    margin-top: auto; 
    display: flex; gap: 10px; padding-bottom: 10px;
}
.bottom-btn {
    flex: 1; height: 45px;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.3);
    color: #fff; border-radius: 12px;
    font-weight: 600; font-size: 14px; cursor: pointer;
}
.bottom-btn:active { background: rgba(255, 255, 255, 0.2); }

/* --- Modals --- */
.modal {
    display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0, 0, 0, 0.9); z-index: 1000;
    align-items: center; justify-content: center;
    backdrop-filter: blur(8px);
}
.modal.show { display: flex; }

/* Target Modal Styling (Matching Image) */
.target-modal-content {
    background: #2a0303; /* Dark Maroon */
    padding: 20px; border-radius: 20px; width: 90%; max-width: 380px;
    border: 2px solid var(--gold-yellow);
    box-shadow: 0 0 30px rgba(0,0,0,0.8);
}
.modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
.modal-title { font-size: 18px; font-weight: 800; color: #fff; display: flex; align-items: center; gap: 8px; }
.close-btn { background: none; border: none; color: #fff; font-size: 24px; cursor: pointer; }

/* Inputs */
.t-label { display: block; font-size: 13px; color: var(--gold-yellow); margin-bottom: 8px; font-weight: 600; }
.t-input {
    width: 100%; padding: 12px; border-radius: 8px; 
    border: 1px solid #5a1a1a;
    background: #3E0505; color: #fff; 
    margin-bottom: 15px; font-size: 14px;
    outline: none;
}
.t-input:focus { border-color: var(--gold-yellow); }

/* Time Grid */
.time-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 8px;
    margin-bottom: 20px;
}
.time-chip-box {
    padding: 8px 0;
    text-align: center;
    border: 1px solid var(--gold-yellow);
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    color: var(--gold-yellow);
    cursor: pointer;
    background: transparent;
    transition: all 0.2s;
}
.time-chip-box.selected {
    background: var(--gold-yellow);
    color: #000;
    font-weight: 800;
    box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
}

/* Progress Box */
.progress-box {
    background: #1a0000;
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 20px;
    text-align: center;
}
.progress-bar-bg {
    height: 8px; background: #333; border-radius: 10px; margin: 10px 0; overflow: hidden;
}
.progress-fill {
    height: 100%; background: linear-gradient(90deg, #FFD700, #FFA500); width: 0%; transition: width 0.5s;
}

/* Save Button */
.full-save-btn {
    width: 100%;
    padding: 14px;
    background: var(--gold-yellow);
    color: #000;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 900;
    cursor: pointer;
    box-shadow: 0 4px 15px rgba(255, 215, 0, 0.2);
}
.full-save-btn:active { transform: scale(0.98); }

/* History Content */
.history-modal-content {
    background: #2d0202; padding: 20px; border-radius: 15px; width: 90%; max-width: 350px; border: 1px solid #555;
}
.history-item { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; margin-bottom: 8px; font-size: 12px; }
.history-date { color: var(--gold-yellow); font-weight: bold; margin-bottom: 5px; }

</style>
</head>
<body onclick="increment(event)">

<div class="app-container">
    
    <div class="header-capsules" onclick="event.stopPropagation()">
        <button class="capsule-btn" onclick="showTargetSettings()">
            üéØ Daily Target
        </button>
    </div>

    <div class="saved-japs-section" onclick="event.stopPropagation()">
        <div class="jap-chip-container" id="japChipsContainer">
            </div>
    </div>

    <div class="add-jap-box hidden" id="addJapBox" onclick="event.stopPropagation()">
        <input type="text" id="newJapInput" placeholder="‡§ú‡§™ ‡§®‡§æ‡§µ..." maxlength="20">
        <button class="save-btn" onclick="addNewJap()">‡§ú‡•ã‡§°‡§æ</button>
        <button class="save-btn" style="background: #ff6b6b;" onclick="cancelAddJap()">√ó</button>
    </div>

    <div class="tip-box">
        üí° ‡§ü‡•Ä‡§™:- ‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§®‡§µ‡§∞ ‡§ï‡•Å‡§†‡•á‡§π‡•Ä ‡§ü‡•Ö‡§™ ‡§ï‡•á‡§≤‡•ç‡§Ø‡§æ‡§∏ ‡§ú‡§™ ‡§Æ‡•ã‡§ú‡§≤‡§æ ‡§ú‡§æ‡§§‡•ã
    </div>

    <div class="display-area">
        <div class="mala-circle">
            <div id="mala-beads"></div>
            <div class="counter-box">
                <div id="currentNaamDisplay">‡§∞‡§æ‡§Æ</div>
                <div id="currentCount">0</div>
                <div style="font-size: 10px; color: #000; font-weight: bold; margin-top: 5px;">/ 108</div>
            </div>
        </div>
    </div>

    <div class="mala-stats">
        <div class="stat-item">
            <span id="statLabel1">‡§Æ‡§æ‡§≥‡§æ</span>
            <span class="stat-v" id="currentMalaCount">0</span>
        </div>
        <div class="stat-item">
            <span id="statLabel2">‡§Ü‡§ú</span>
            <span class="stat-v" id="currentTodayTotal">0</span>
        </div>
        <div class="stat-item">
            <span id="statLabel3">‡§è‡§ï‡•Ç‡§£</span>
            <span class="stat-v" id="currentLifeTotal">0</span>
        </div>
    </div>

    <div class="bottom-controls" onclick="event.stopPropagation()">
        <button class="bottom-btn" onclick="resetToday(event)">üîÑ ‡§∞‡§ø‡§∏‡•á‡§ü</button>
        <button class="bottom-btn" onclick="showHistory(event)">üìú ‡§á‡§§‡§ø‡§π‡§æ‡§∏</button>
    </div>

</div>

<div class="modal" id="targetModal" onclick="closeTargetModal()">
    <div class="target-modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <div class="modal-title">üéØ Daily Target ‡§∏‡•á‡§ü ‡§ï‡§∞‡§æ</div>
            <button class="close-btn" onclick="closeTargetModal()">√ó</button>
        </div>
        
        <label class="t-label">‡§ï‡§ø‡§§‡•Ä ‡§Æ‡§æ‡§≥‡§æ ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§ï‡§∞‡§æ‡§Ø‡§ö‡•ç‡§Ø‡§æ ‡§Ü‡§π‡•á‡§§?</label>
        <input type="number" class="t-input" id="targetMalaInput" placeholder="‡§â‡§¶‡§æ. 11" min="1">
        
        <label class="t-label">‡§ï‡•ã‡§£‡§§‡•ç‡§Ø‡§æ ‡§ú‡§™‡§æ‡§ö‡•á ‡§ü‡§æ‡§∞‡•ç‡§ó‡•á‡§ü ‡§Ü‡§π‡•á?</label>
        <input type="text" class="t-input" id="targetJapInput" placeholder="‡§â‡§¶‡§æ. ‡§∞‡§æ‡§Æ, ‡§ï‡•É‡§∑‡•ç‡§£, ‡§∂‡§ø‡§µ">
        
        <label class="t-label">‚è∞ ‡§ï‡§ß‡•Ä ‡§ï‡§ß‡•Ä ‡§Ü‡§†‡§µ‡§£ ‡§ï‡§∞‡•Ç? (‡§µ‡•á‡§≥ ‡§®‡§ø‡§µ‡§°‡§æ)</label>
        <div class="time-grid" id="timeGrid">
            </div>

        <div class="progress-box">
            <label style="font-size: 12px; color: #ddd;">üìä ‡§Ü‡§ú‡§ö‡•Ä Progress</label>
            <div class="progress-bar-bg">
                <div class="progress-fill" id="modalProgressBar"></div>
            </div>
            <div id="modalTargetStatus" style="font-size: 13px; color: var(--gold-yellow); font-weight: bold;">Target ‡§∏‡•á‡§ü ‡§ï‡§∞‡§æ</div>
        </div>
        
        <button class="full-save-btn" onclick="saveTargetSettings()">‚úÖ ‡§∏‡•á‡§µ‡•ç‡§π ‡§ï‡§∞‡§æ</button>
    </div>
</div>

<div class="modal" id="historyModal" onclick="closeHistory()">
    <div class="history-modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h3 style="margin: 0; color:var(--gold-yellow)">üìú ‡§á‡§§‡§ø‡§π‡§æ‡§∏</h3>
            <button class="close-btn" onclick="closeHistory()">√ó</button>
        </div>
        <div id="historyContent" style="max-height: 300px; overflow-y: auto;"></div>
    </div>
</div>

<script>
// Core Data
let allJaps = {};
let currentNaam = "‡§∞‡§æ‡§Æ";
let targetMalas = 0;
let todayDate = new Date().toDateString();
let history = [];
let selectedNotificationTimes = [7, 12, 17, 21];
let targetJapName = "";

function loadData() {
    const stored = JSON.parse(localStorage.getItem("malaAppData") || "{}");
    allJaps = stored.allJaps || { "‡§∞‡§æ‡§Æ": { count: 0, todayTotal: 0, lifeTotal: 0 } };
    currentNaam = stored.currentNaam || "‡§∞‡§æ‡§Æ";
    targetMalas = stored.targetMalas || 0;
    targetJapName = stored.targetJapName || "";
    selectedNotificationTimes = stored.selectedNotificationTimes || [7, 12, 17, 21];
    history = stored.history || [];
    
    if (stored.todayDate !== todayDate) {
        saveDailyHistory();
        resetDailyData();
    }
}

function saveDailyHistory() {
    const yesterdayData = {
        date: localStorage.getItem("malaAppData") ? JSON.parse(localStorage.getItem("malaAppData")).todayDate : todayDate,
        japs: {}
    };
    let hadData = false;
    for (let naam in allJaps) {
        if (allJaps[naam].todayTotal > 0) {
            yesterdayData.japs[naam] = { count: allJaps[naam].todayTotal, malas: Math.floor(allJaps[naam].todayTotal / 108) };
            hadData = true;
        }
    }
    if (hadData) {
        history.unshift(yesterdayData);
        if (history.length > 30) history = history.slice(0, 30);
    }
}

function resetDailyData() {
    for (let naam in allJaps) {
        allJaps[naam].todayTotal = 0;
    }
}

function saveData() {
    const data = { allJaps, currentNaam, targetMalas, targetJapName, selectedNotificationTimes, todayDate, history };
    localStorage.setItem("malaAppData", JSON.stringify(data));
}

function init() {
    loadData();
    createMala();
    renderJapChips();
    updateUI();
    requestNotificationPermission();
    setupNotifications();
}

function createMala() {
    const container = document.getElementById("mala-beads");
    container.innerHTML = "";
    for (let i = 0; i < 108; i++) {
        const bead = document.createElement("div");
        bead.className = "bead";
        const angle = (i / 108) * 2 * Math.PI;
        const x = 140 + 125 * Math.cos(angle) - 5;
        const y = 140 + 125 * Math.sin(angle) - 5;
        bead.style.left = x + "px";
        bead.style.top = y + "px";
        container.appendChild(bead);
    }
}

function renderJapChips() {
    const container = document.getElementById("japChipsContainer");
    container.innerHTML = "";
    
    for (let naam in allJaps) {
        const chip = document.createElement("div");
        // Only show Name, no count
        chip.className = "jap-chip" + (naam === currentNaam ? " active" : "");
        chip.onclick = () => switchToJap(naam);
        
        chip.innerHTML = `<span>${naam}</span>`;

        if (Object.keys(allJaps).length > 1) {
            const delBtn = document.createElement("button");
            delBtn.className = "delete-chip";
            delBtn.innerHTML = "√ó";
            delBtn.onclick = (e) => {
                e.stopPropagation();
                if(confirm("‡§°‡§ø‡§≤‡•Ä‡§ü ‡§ï‡§∞‡§æ‡§Ø‡§ö‡•á?")) deleteJap(naam);
            };
            chip.appendChild(delBtn);
        }
        container.appendChild(chip);
    }
    
    // Add Button
    const addBtn = document.createElement("div");
    addBtn.className = "add-jap-btn";
    addBtn.innerHTML = "+";
    addBtn.onclick = showAddJapInput;
    container.appendChild(addBtn);
}

function showAddJapInput() {
    document.getElementById("addJapBox").classList.remove("hidden");
    document.getElementById("newJapInput").focus();
}

function cancelAddJap() {
    document.getElementById("addJapBox").classList.add("hidden");
    document.getElementById("newJapInput").value = "";
}

function addNewJap() {
    const input = document.getElementById("newJapInput");
    const naam = input.value.trim();
    if (!naam) return;
    
    if (allJaps[naam]) {
        switchToJap(naam);
    } else {
        allJaps[naam] = { count: 0, todayTotal: 0, lifeTotal: 0 };
        currentNaam = naam;
        saveData();
    }
    cancelAddJap();
    renderJapChips();
    updateUI();
}

function switchToJap(naam) {
    currentNaam = naam;
    saveData();
    renderJapChips();
    updateUI();
}

function deleteJap(naam) {
    delete allJaps[naam];
    if (currentNaam === naam) currentNaam = Object.keys(allJaps)[0];
    saveData();
    renderJapChips();
    updateUI();
}

function increment(e) {
    if (e) {
        // Prevent clicks on controls from counting
        if (e.target.closest('.header-capsules') || 
            e.target.closest('.saved-japs-section') ||
            e.target.closest('.add-jap-box') ||
            e.target.closest('.bottom-controls') ||
            e.target.closest('.modal')) return;
    }

    let currentVal = allJaps[currentNaam].count + 1;
    allJaps[currentNaam].todayTotal = (allJaps[currentNaam].todayTotal || 0) + 1;
    allJaps[currentNaam].lifeTotal = (allJaps[currentNaam].lifeTotal || 0) + 1;

    if (currentVal >= 108) {
        if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
        currentVal = 0;
        showMalaComplete();
    } else {
        if (navigator.vibrate) navigator.vibrate(20);
    }

    allJaps[currentNaam].count = currentVal;
    
    // Animation
    const countEl = document.getElementById("currentCount");
    countEl.classList.remove("animate");
    void countEl.offsetWidth; 
    countEl.classList.add("animate");
    
    const beads = document.querySelectorAll(".bead");
    if(beads[currentVal-1]) {
        beads[currentVal-1].classList.add("active");
    }

    saveData();
    updateUI();
}

function showMalaComplete() {
    const msg = document.createElement("div");
    msg.innerText = "üö© ‡§Æ‡§æ‡§≥‡§æ ‡§™‡•Ç‡§∞‡•ç‡§£! üö©";
    msg.style.cssText = "position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#FFD700; color:#000; padding:15px 30px; border-radius:20px; font-weight:900; z-index:2000; font-size:20px; box-shadow:0 10px 30px rgba(0,0,0,0.5);";
    document.body.appendChild(msg);
    setTimeout(() => msg.remove(), 2000);
}

function updateUI() {
    const data = allJaps[currentNaam];
    document.getElementById("currentCount").innerText = data.count;
    document.getElementById("currentNaamDisplay").innerText = currentNaam;
    
    document.getElementById("statLabel1").innerText = `‡§Æ‡§æ‡§≥‡§æ (${currentNaam})`;
    document.getElementById("statLabel2").innerText = `‡§Ü‡§ú (${currentNaam})`;
    document.getElementById("statLabel3").innerText = `‡§è‡§ï‡•Ç‡§£ (${currentNaam})`;

    document.getElementById("currentMalaCount").innerText = Math.floor(data.lifeTotal / 108);
    document.getElementById("currentTodayTotal").innerText = data.todayTotal;
    document.getElementById("currentLifeTotal").innerText = data.lifeTotal;

    const beads = document.querySelectorAll(".bead");
    beads.forEach((b, i) => {
        b.className = i < data.count ? "bead active" : "bead";
    });
}

function resetToday(e) {
    if(e) e.stopPropagation();
    if(confirm("‡§Ü‡§ú‡§ö‡§æ ‡§ú‡§™ ‡§∞‡§ø‡§∏‡•á‡§ü ‡§ï‡§∞‡§æ‡§Ø‡§ö‡§æ ‡§ï‡§æ?")) {
        allJaps[currentNaam].todayTotal = 0;
        allJaps[currentNaam].count = 0;
        saveData();
        updateUI();
    }
}

// History
function showHistory(e) {
    if(e) e.stopPropagation();
    const list = document.getElementById("historyContent");
    if(!history.length) list.innerHTML = "<div style='text-align:center; opacity:0.6; margin-top:20px;'>‡§á‡§§‡§ø‡§π‡§æ‡§∏ ‡§®‡§æ‡§π‡•Ä</div>";
    else {
        list.innerHTML = history.map(h => {
            let details = "";
            for(let n in h.japs) details += `<div>${n}: ${h.japs[n].count}</div>`;
            return `<div class="history-item"><div class="history-date">${h.date}</div>${details}</div>`;
        }).join("");
    }
    document.getElementById("historyModal").classList.add("show");
}
function closeHistory() { document.getElementById("historyModal").classList.remove("show"); }

// Target Modal Logic
function showTargetSettings() {
    document.getElementById("targetMalaInput").value = targetMalas || "";
    document.getElementById("targetJapInput").value = targetJapName || "";
    renderTimeGrid();
    
    let totalToday = 0;
    for(let n in allJaps) totalToday += Math.floor(allJaps[n].todayTotal / 108);
    
    const bar = document.getElementById("modalProgressBar");
    const stat = document.getElementById("modalTargetStatus");
    
    if(targetMalas > 0) {
        const pct = Math.min((totalToday/targetMalas)*100, 100);
        bar.style.width = pct + "%";
        stat.innerText = `${totalToday} / ${targetMalas} ‡§Æ‡§æ‡§≥‡§æ ‡§™‡•Ç‡§∞‡•ç‡§£`;
    } else {
        bar.style.width = "0%";
        stat.innerText = "Target ‡§∏‡•á‡§ü ‡§ï‡§∞‡§æ";
    }

    document.getElementById("targetModal").classList.add("show");
}
function closeTargetModal() { document.getElementById("targetModal").classList.remove("show"); }

function renderTimeGrid() {
    const grid = document.getElementById("timeGrid");
    const times = [6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22];
    grid.innerHTML = times.map(t => {
        const label = t + ":00";
        const isSel = selectedNotificationTimes.includes(t);
        return `<div class="time-chip-box ${isSel ? 'selected' : ''}" onclick="toggleTime(${t})">${label}</div>`;
    }).join("");
}

function toggleTime(t) {
    const i = selectedNotificationTimes.indexOf(t);
    if(i>-1) selectedNotificationTimes.splice(i,1);
    else selectedNotificationTimes.push(t);
    renderTimeGrid();
}

function saveTargetSettings() {
    targetMalas = parseInt(document.getElementById("targetMalaInput").value);
    targetJapName = document.getElementById("targetJapInput").value;
    saveData();
    closeTargetModal();
    setupNotifications();
}

// Notifications
function requestNotificationPermission() {
    if ("Notification" in window && Notification.permission === "default") Notification.requestPermission();
}
function setupNotifications() {
    if(window.notifInterval) clearInterval(window.notifInterval);
    window.notifInterval = setInterval(() => {
        const h = new Date().getHours();
        const m = new Date().getMinutes();
        if(m === 0 && selectedNotificationTimes.includes(h) && targetMalas > 0) {
             new Notification("‡§ú‡§™ ‡§Ü‡§†‡§µ‡§£", { body: "‡§ú‡§™ ‡§ï‡§∞‡§æ‡§Ø‡§ö‡•Ä ‡§µ‡•á‡§≥ ‡§ù‡§æ‡§≤‡•Ä ‡§Ü‡§π‡•á!" });
        }
    }, 60000);
}

init();
</script>
</body>
</html>
