<!DOCTYPE html>
<html lang="mr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Premium Rudraksha Mala</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root {
    --bg-maroon: #4A0404;
    --gold-yellow: #FFD700;
    --text-color: #ffffff;
}

* { box-sizing: border-box; }

body, html {
    margin: 0; padding: 0;
    width: 100%; height: 100%;
    font-family: 'Poppins', sans-serif;
    background: linear-gradient(135deg, #4A0404 0%, #2d0202 100%);
    color: var(--text-color);
    overflow: hidden;
}

.app-container {
    max-width: 450px;
    margin: 0 auto;
    height: 100vh;
    display: flex;
    flex-direction: column;
    padding: 15px;
}

/* Header Capsules */
.header-capsules {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    gap: 10px;
}
.capsule-btn {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    background: linear-gradient(135deg, rgba(255, 215, 0, 0.3), rgba(255, 165, 0, 0.3));
    border: 2px solid var(--gold-yellow);
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 800;
    cursor: pointer;
    transition: all 0.2s;
    color: var(--gold-yellow);
}
.capsule-btn:hover {
    background: linear-gradient(135deg, var(--gold-yellow), #FFA500);
    color: #000;
    transform: scale(1.05);
}
.capsule-btn:active {
    transform: scale(0.95);
}
.target-section label { 
    font-size: 13px; 
    display: block; 
    margin-bottom: 8px; 
    text-align: center;
}
.target-input-group { 
    display: flex; 
    justify-content: center; 
    gap: 10px; 
    align-items: center;
}
.target-input-group input { 
    width: 80px; 
    padding: 8px; 
    border-radius: 8px; 
    border: none; 
    text-align: center; 
    font-weight: bold;
    font-size: 16px;
}
.save-btn {
    background: var(--gold-yellow); 
    color: #000; 
    border: none; 
    padding: 8px 15px; 
    border-radius: 8px; 
    font-weight: 800; 
    cursor: pointer;
    transition: transform 0.2s;
    font-size: 12px;
}
.save-btn:active {
    transform: scale(0.95);
}
.target-status {
    font-size: 12px;
    font-weight: 600;
}

/* Target Settings Modal */
.target-modal-body {
    padding: 15px 0;
}
.target-input-field {
    margin-bottom: 15px;
}
.target-input-field label {
    display: block;
    font-size: 13px;
    font-weight: 600;
    margin-bottom: 5px;
    color: var(--gold-yellow);
}
.target-input-field input {
    width: 100%;
    padding: 10px;
    border-radius: 8px;
    border: 2px solid rgba(255, 215, 0, 0.3);
    background: rgba(255, 255, 255, 0.1);
    color: #fff;
    font-size: 15px;
    font-weight: 600;
    outline: none;
}
.target-input-field input:focus {
    border-color: var(--gold-yellow);
}
.target-progress-display {
    background: rgba(255, 255, 255, 0.05);
    padding: 12px;
    border-radius: 8px;
    margin-top: 15px;
}
.target-progress-display label {
    display: block;
    font-size: 12px;
    margin-bottom: 8px;
    text-align: center;
    opacity: 0.9;
}
.progress-bar-container {
    width: 100%;
    height: 8px;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 10px;
    overflow: hidden;
    margin-bottom: 8px;
}
.progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #FFD700, #FFA500);
    transition: width 0.5s ease;
    box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
}
.target-status {
    font-size: 13px;
    font-weight: 700;
    color: var(--gold-yellow);
    text-align: center;
    display: block;
}
.notification-times {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 8px;
}
.time-chip {
    background: rgba(255, 215, 0, 0.2);
    border: 2px solid rgba(255, 215, 0, 0.4);
    padding: 6px 12px;
    border-radius: 15px;
    font-size: 12px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
}
.time-chip.selected {
    background: var(--gold-yellow);
    color: #000;
    border-color: var(--gold-yellow);
}
.save-target-btn {
    width: 100%;
    padding: 12px;
    background: linear-gradient(135deg, var(--gold-yellow), #FFA500);
    color: #000;
    border: none;
    border-radius: 10px;
    font-size: 16px;
    font-weight: 900;
    cursor: pointer;
    margin-top: 15px;
    transition: all 0.2s;
}
.save-target-btn:active {
    transform: scale(0.95);
}

/* Audio Jap Modal */
.audio-jap-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 15px;
}
.audio-jap-item {
    background: rgba(255, 255, 255, 0.1);
    padding: 15px;
    border-radius: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border: 2px solid rgba(255, 215, 0, 0.3);
}
.audio-jap-info {
    flex: 1;
}
.audio-jap-name {
    font-size: 16px;
    font-weight: 800;
    color: var(--gold-yellow);
    margin-bottom: 5px;
}
.audio-jap-count {
    font-size: 12px;
    opacity: 0.8;
}
.audio-play-btn {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--gold-yellow), #FFA500);
    border: none;
    font-size: 24px;
    cursor: pointer;
    transition: all 0.2s;
}
.audio-play-btn:active {
    transform: scale(0.9);
}
.audio-play-btn.playing {
    background: linear-gradient(135deg, #ff6b6b, #ff4444);
}

/* Progress Bar */
.progress-bar-container {
    width: 100%;
    height: 8px;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 10px;
    overflow: hidden;
    margin-top: 8px;
}
.progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #FFD700, #FFA500);
    transition: width 0.5s ease;
    box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
}

/* Saved Japs Section */
.saved-japs-section {
    background: rgba(255, 255, 255, 0.1);
    padding: 10px;
    border-radius: 12px;
    margin-bottom: 10px;
    backdrop-filter: blur(10px);
    max-height: 120px;
    overflow-y: auto;
}
.saved-japs-title {
    font-size: 12px;
    font-weight: 700;
    margin-bottom: 8px;
    text-align: center;
    opacity: 0.9;
}
.jap-chip-container {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    justify-content: center;
    align-items: center;
}
.jap-chip {
    background: rgba(255, 215, 0, 0.2);
    border: 2px solid rgba(255, 215, 0, 0.5);
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 5px;
}
.jap-chip:hover {
    background: rgba(255, 215, 0, 0.3);
}
.jap-chip.active {
    background: var(--gold-yellow);
    color: #000;
    border-color: var(--gold-yellow);
}
.jap-chip-count {
    font-size: 10px;
    opacity: 0.8;
}
.delete-chip {
    background: rgba(255, 0, 0, 0.3);
    border: none;
    color: #fff;
    font-size: 10px;
    padding: 2px 5px;
    border-radius: 10px;
    cursor: pointer;
    margin-left: 3px;
}
.add-jap-btn {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: rgba(255, 215, 0, 0.3);
    border: 2px solid var(--gold-yellow);
    color: var(--gold-yellow);
    font-size: 20px;
    font-weight: 900;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}
.add-jap-btn:hover {
    background: var(--gold-yellow);
    color: #000;
    transform: scale(1.1);
}
.add-jap-btn:active {
    transform: scale(0.95);
}

/* Add New Jap Input */
.add-jap-box {
    display: flex; 
    gap: 6px; 
    margin-bottom: 10px;
}
.add-jap-box input {
    flex: 1; 
    padding: 10px; 
    border-radius: 10px; 
    border: none; 
    font-weight: 600; 
    outline: none;
    font-size: 14px;
}
.add-jap-box.hidden {
    display: none;
}

/* Tip Box */
.tip-box {
    background: rgba(255, 255, 255, 0.95);
    color: #4A0404;
    padding: 10px;
    border-radius: 10px;
    margin-bottom: 10px;
    text-align: center;
    font-size: 11px;
    line-height: 1.5;
    font-weight: 600;
    border: 2px solid rgba(255, 215, 0, 0.5);
}

/* Mala Display */
.display-area {
    position: relative; 
    flex: 1; 
    display: flex; 
    justify-content: center; 
    align-items: center;
}
.mala-circle {
    position: relative; 
    width: 280px; 
    height: 280px; 
    display: flex; 
    justify-content: center; 
    align-items: center;
}
#mala-beads { 
    position: absolute; 
    width: 100%; 
    height: 100%; 
    transform: rotate(-90deg); 
}
.bead { 
    position: absolute; 
    width: 10px; 
    height: 10px; 
    background: rgba(255,255,255,0.25); 
    border-radius: 50%; 
    transition: all 0.3s ease;
    border: 1px solid rgba(255, 255, 255, 0.1);
}
.bead.active { 
    background: var(--gold-yellow); 
    box-shadow: 0 0 12px var(--gold-yellow); 
    transform: scale(1.4);
    border-color: #fff;
}
.bead.pulse {
    animation: pulse 0.5s ease;
}

@keyframes pulse {
    0%, 100% { transform: scale(1.4); }
    50% { transform: scale(1.8); }
}

.counter-box {
    width: 150px; 
    height: 150px; 
    background: linear-gradient(135deg, #FFD700, #FFA500);
    border-radius: 50%;
    display: flex; 
    flex-direction: column; 
    justify-content: center; 
    align-items: center;
    box-shadow: 0 5px 30px rgba(0,0,0,0.6); 
    z-index: 5; 
    border: 5px solid #fff;
}
#currentCount { 
    font-size: 60px; 
    font-weight: 900; 
    color: #000; 
    line-height: 1;
    transition: all 0.3s ease;
}
#currentCount.animate {
    animation: countPop 0.3s ease;
}

@keyframes countPop {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.2); }
}

#currentNaamDisplay { 
    font-size: 14px; 
    color: #4A0404; 
    font-weight: 800;
    max-width: 130px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* Stats */
.mala-stats {
    display: flex; 
    justify-content: space-around; 
    background: rgba(0,0,0,0.3); 
    padding: 12px; 
    border-radius: 12px; 
    margin-bottom: 12px;
    backdrop-filter: blur(10px);
}
.stat-item { 
    text-align: center; 
    flex: 1;
}
.stat-item span:first-child {
    display: block;
    font-size: 10px;
    opacity: 0.9;
    margin-bottom: 3px;
}
.stat-v { 
    display: block; 
    font-size: 18px; 
    font-weight: 800; 
    color: var(--gold-yellow);
}

/* Controls */
.button-group {
    display: flex;
    gap: 8px;
    margin-bottom: 8px;
}
.small-btn {
    flex: 1;
    height: 42px;
    border-radius: 10px;
    border: 2px solid #fff;
    background: rgba(255, 255, 255, 0.1);
    color: #fff;
    font-size: 11px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
    backdrop-filter: blur(10px);
}
.small-btn:active {
    transform: scale(0.95);
}

.jap-main-btn {
    width: 100%; 
    height: 100px; 
    background: linear-gradient(135deg, #fff, #f0f0f0);
    color: #4A0404; 
    border: none; 
    border-radius: 15px;
    font-size: 32px; 
    font-weight: 900; 
    box-shadow: 0 5px 20px rgba(0,0,0,0.4); 
    cursor: pointer;
    transition: all 0.2s;
}
.jap-main-btn:active {
    transform: translateY(2px);
    box-shadow: 0 3px 15px rgba(0,0,0,0.3);
}

/* Modal */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(5px);
}
.modal.show {
    display: flex;
}
.modal-content {
    background: linear-gradient(135deg, #4A0404, #2d0202);
    padding: 20px;
    border-radius: 15px;
    max-width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    border: 2px solid var(--gold-yellow);
}
.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}
.close-btn {
    background: none;
    border: none;
    color: #fff;
    font-size: 24px;
    cursor: pointer;
}
.history-item {
    background: rgba(255, 255, 255, 0.1);
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 10px;
}
.history-date {
    font-weight: 800;
    color: var(--gold-yellow);
    margin-bottom: 8px;
}
.history-jap-entry {
    background: rgba(255, 255, 255, 0.05);
    padding: 8px;
    border-radius: 6px;
    margin-top: 6px;
    font-size: 13px;
}
</style>
</head>
<body onclick="increment(event)">

<div class="app-container">
<div class="app-container">
    <!-- Header Capsules -->
    <div class="header-capsules" onclick="event.stopPropagation()">
        <button class="capsule-btn" onclick="showTargetSettings()">
            üéØ Daily Target
        </button>
        <button class="capsule-btn" onclick="showAudioJap()">
            üîä Audio Jap
        </button>
    </div>

    <!-- Saved Japs with Quick Switch -->
    <div class="saved-japs-section" onclick="event.stopPropagation()">
        <div class="saved-japs-title">üìø ‡§Æ‡§æ‡§ù‡•á ‡§ú‡§™</div>
        <div class="jap-chip-container" id="japChipsContainer">
            <!-- Chips will be rendered here -->
        </div>
    </div>

    <!-- Add New Jap (Hidden by default) -->
    <div class="add-jap-box hidden" id="addJapBox" onclick="event.stopPropagation()">
        <input type="text" id="newJapInput" placeholder="‡§®‡§µ‡•Ä‡§® ‡§ú‡§™ ‡§®‡§æ‡§µ ‡§≤‡§ø‡§π‡§æ...">
        <button class="save-btn" onclick="addNewJap()">‚úÖ ‡§ú‡•ã‡§°‡§æ</button>
        <button class="save-btn" style="background: #ff6b6b;" onclick="cancelAddJap()">‚ùå</button>
    </div>

    <!-- Tip Box -->
    <div class="tip-box">
        üí° ‡§ü‡•Ä‡§™:- ‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§®‡§µ‡§∞ ‡§ï‡•Å‡§†‡•á‡§π‡•Ä ‡§ü‡•Ö‡§™ ‡§ï‡•á‡§≤‡•ç‡§Ø‡§æ‡§∏ ‡§µ volume button ‡§™‡•ç‡§∞‡•á‡§∏ ‡§ï‡•á‡§≤‡•ç‡§Ø‡§æ‡§∏ ‡§ú‡§™ ‡§Æ‡•ã‡§ú‡§≤‡§æ ‡§ú‡§æ‡§§‡•ã
    </div>

    <!-- Mala Display -->
    <div class="display-area">
        <div class="mala-circle">
            <div id="mala-beads"></div>
            <div class="counter-box">
                <div id="currentNaamDisplay">‡§∞‡§æ‡§Æ</div>
                <div id="currentCount">0</div>
                <div style="font-size: 10px; color: #000; font-weight: bold;">/ 108</div>
            </div>
        </div>
    </div>

    <!-- Stats -->
    <div class="mala-stats">
        <div class="stat-item">
            <span id="statLabel1">‡§Æ‡§æ‡§≥‡§æ</span>
            <span class="stat-v" id="currentMalaCount">0</span>
        </div>
        <div class="stat-item">
            <span id="statLabel2">‡§Ü‡§ú‡§ö‡§æ ‡§ú‡§™</span>
            <span class="stat-v" id="currentTodayTotal">0</span>
        </div>
        <div class="stat-item">
            <span id="statLabel3">‡§è‡§ï‡•Ç‡§£ ‡§ú‡§™</span>
            <span class="stat-v" id="currentLifeTotal">0</span>
        </div>
    </div>

    <!-- Control Buttons -->
    <div>
        <div class="button-group" onclick="event.stopPropagation()">
            <button class="small-btn" onclick="resetToday(event)">‡§∞‡§ø‡§∏‡•á‡§ü</button>
            <button class="small-btn" onclick="showHistory(event)">‡§á‡§§‡§ø‡§π‡§æ‡§∏</button>
        </div>
        <button class="jap-main-btn" onclick="handleJapButtonClick(event)">üôè ‡§ú‡§™ ‡§Æ‡•ã‡§ú‡§æ üôè</button>
    </div>
</div>

<!-- History Modal -->
<div class="modal" id="historyModal" onclick="closeHistory()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h3 style="margin: 0;">üìú ‡§ú‡§™ ‡§á‡§§‡§ø‡§π‡§æ‡§∏</h3>
            <button class="close-btn" onclick="closeHistory()">√ó</button>
        </div>
        <div id="historyContent"></div>
    </div>
</div>

<!-- Target Settings Modal -->
<div class="modal" id="targetModal" onclick="closeTargetModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h3 style="margin: 0;">üéØ Daily Target ‡§∏‡•á‡§ü ‡§ï‡§∞‡§æ</h3>
            <button class="close-btn" onclick="closeTargetModal()">√ó</button>
        </div>
        <div class="target-modal-body">
            <div class="target-input-field">
                <label>‡§ï‡§ø‡§§‡•Ä ‡§Æ‡§æ‡§≥‡§æ ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§ï‡§∞‡§æ‡§Ø‡§ö‡•ç‡§Ø‡§æ ‡§Ü‡§π‡•á‡§§?</label>
                <input type="number" id="targetMalaInput" placeholder="‡§â‡§¶‡§æ. 11" min="1" max="108">
            </div>
            
            <div class="target-input-field">
                <label>‡§ï‡•ã‡§£‡§§‡•ç‡§Ø‡§æ ‡§ú‡§™‡§æ‡§ö‡•á ‡§ü‡§æ‡§∞‡•ç‡§ó‡•á‡§ü ‡§Ü‡§π‡•á?</label>
                <input type="text" id="targetJapInput" placeholder="‡§â‡§¶‡§æ. ‡§∞‡§æ‡§Æ, ‡§ï‡•É‡§∑‡•ç‡§£, ‡§∂‡§ø‡§µ" value="">
            </div>
            
            <div class="target-input-field">
                <label>‚è∞ ‡§ï‡§ß‡•Ä ‡§ï‡§ß‡•Ä ‡§Ü‡§†‡§µ‡§£ ‡§ï‡§∞‡•Ç? (‡§µ‡•á‡§≥ ‡§®‡§ø‡§µ‡§°‡§æ)</label>
                <div class="notification-times" id="notificationTimes"></div>
            </div>
            
            <div class="target-progress-display">
                <label>üìä ‡§Ü‡§ú‡§ö‡•Ä Progress</label>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="modalProgressBar"></div>
                </div>
                <span class="target-status" id="modalTargetStatus">Target ‡§∏‡•á‡§ü ‡§ï‡§∞‡§æ</span>
            </div>
            
            <button class="save-target-btn" onclick="saveTargetSettings()">‚úÖ ‡§∏‡•á‡§µ‡•ç‡§π ‡§ï‡§∞‡§æ</button>
        </div>
    </div>
</div>

<!-- Audio Jap Modal -->
<div class="modal" id="audioJapModal" onclick="closeAudioJapModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h3 style="margin: 0;">üîä Audio Jap</h3>
            <button class="close-btn" onclick="closeAudioJapModal()">√ó</button>
        </div>
        <div class="audio-jap-list" id="audioJapList"></div>
    </div>
</div>

<script>
// Data structures
let allJaps = {};
let currentNaam = "‡§∞‡§æ‡§Æ";
let targetMalas = 0;
let todayDate = new Date().toDateString();
let history = [];
let notificationSchedule = [];
let selectedNotificationTimes = [7, 12, 17, 21];
let targetJapName = "";

// Audio Jap data
let audioJaps = {
    "‡§∞‡§æ‡§Æ": {
        url: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3",
        count: 0,
        playing: false
    },
    "‡§ï‡•É‡§∑‡•ç‡§£": {
        url: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3",
        count: 0,
        playing: false
    },
    "‡§∏‡•ç‡§µ‡§æ‡§Æ‡•Ä ‡§∏‡§Æ‡§∞‡•ç‡§•": {
        url: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3",
        count: 0,
        playing: false
    }
};
let currentAudio = null;
let audioCountInterval = null;

// Load data
function loadData() {
    const stored = JSON.parse(localStorage.getItem("malaAppData") || "{}");
    
    allJaps = stored.allJaps || { "‡§∞‡§æ‡§Æ": { count: 0, todayTotal: 0, lifeTotal: 0 } };
    currentNaam = stored.currentNaam || "‡§∞‡§æ‡§Æ";
    targetMalas = stored.targetMalas || 0;
    targetJapName = stored.targetJapName || "";
    selectedNotificationTimes = stored.selectedNotificationTimes || [7, 12, 17, 21];
    history = stored.history || [];
    notificationSchedule = stored.notificationSchedule || [];
    audioJaps = stored.audioJaps || audioJaps;
    
    const storedDate = stored.todayDate;
    if (storedDate !== todayDate) {
        saveDailyHistory();
        resetDailyData();
    }
}

function saveDailyHistory() {
    const yesterdayData = {
        date: localStorage.getItem("malaAppData") ? JSON.parse(localStorage.getItem("malaAppData")).todayDate : todayDate,
        japs: {}
    };
    
    let hadData = false;
    for (let naam in allJaps) {
        const totalToday = allJaps[naam].todayTotal || 0;
        if (totalToday > 0) {
            yesterdayData.japs[naam] = {
                count: totalToday,
                malas: Math.floor(totalToday / 108)
            };
            hadData = true;
        }
    }
    
    if (hadData) {
        history.unshift(yesterdayData);
        if (history.length > 60) history = history.slice(0, 60);
    }
}

function resetDailyData() {
    for (let naam in allJaps) {
        allJaps[naam].count = 0;
        allJaps[naam].todayTotal = 0;
    }
}

function saveData() {
    const data = {
        allJaps,
        currentNaam,
        targetMalas,
        targetJapName,
        selectedNotificationTimes,
        todayDate,
        history,
        notificationSchedule,
        audioJaps
    };
    localStorage.setItem("malaAppData", JSON.stringify(data));
}

// Initialize
function init() {
    loadData();
    createMala();
    updateUI();
    renderJapChips();
    requestNotificationPermission();
    setupNotifications();
    setupVolumeListener();
}

function createMala() {
    const container = document.getElementById("mala-beads");
    container.innerHTML = "";
    for (let i = 0; i < 108; i++) {
        const bead = document.createElement("div");
        bead.className = "bead";
        const angle = (i / 108) * 2 * Math.PI;
        const x = 140 + 125 * Math.cos(angle) - 5;
        const y = 140 + 125 * Math.sin(angle) - 5;
        bead.style.left = x + "px";
        bead.style.top = y + "px";
        container.appendChild(bead);
    }
}

// Render saved jap chips
function renderJapChips() {
    const container = document.getElementById("japChipsContainer");
    container.innerHTML = "";
    
    for (let naam in allJaps) {
        const chip = document.createElement("div");
        chip.className = "jap-chip" + (naam === currentNaam ? " active" : "");
        
        const nameSpan = document.createElement("span");
        nameSpan.textContent = naam;
        
        const countSpan = document.createElement("span");
        countSpan.className = "jap-chip-count";
        countSpan.textContent = `(${allJaps[naam].count}/108)`;
        
        const deleteBtn = document.createElement("button");
        deleteBtn.className = "delete-chip";
        deleteBtn.textContent = "√ó";
        deleteBtn.onclick = (e) => {
            e.stopPropagation();
            if (confirm(`"${naam}" ‡§π‡§æ ‡§ú‡§™ ‡§°‡§ø‡§≤‡•Ä‡§ü ‡§ï‡§∞‡§æ‡§Ø‡§ö‡§æ ‡§ï‡§æ?`)) {
                if (confirm(`‡§ñ‡§æ‡§§‡•ç‡§∞‡•Ä ‡§Ü‡§π‡•á? ${naam} ‡§ö‡§æ ‡§∏‡§∞‡•ç‡§µ ‡§°‡•á‡§ü‡§æ ‡§ï‡§æ‡§Ø‡§Æ‡§ö‡§æ ‡§°‡§ø‡§≤‡•Ä‡§ü ‡§π‡•ã‡§à‡§≤!`)) {
                    deleteJap(naam);
                }
            }
        };
        
        chip.appendChild(nameSpan);
        chip.appendChild(countSpan);
        if (Object.keys(allJaps).length > 1) {
            chip.appendChild(deleteBtn);
        }
        
        chip.onclick = () => switchToJap(naam);
        container.appendChild(chip);
    }
    
    // Add + button
    const addBtn = document.createElement("button");
    addBtn.className = "add-jap-btn";
    addBtn.textContent = "+";
    addBtn.onclick = showAddJapInput;
    container.appendChild(addBtn);
}

// Show add jap input
function showAddJapInput() {
    document.getElementById("addJapBox").classList.remove("hidden");
    document.getElementById("newJapInput").focus();
}

// Cancel add jap
function cancelAddJap() {
    document.getElementById("addJapBox").classList.add("hidden");
    document.getElementById("newJapInput").value = "";
}

// Add new jap
function addNewJap() {
    const input = document.getElementById("newJapInput");
    const naam = input.value.trim();
    
    if (naam === "") {
        alert("‡§ï‡•É‡§™‡§Ø‡§æ ‡§®‡§æ‡§µ ‡§≤‡§ø‡§π‡§æ!");
        return;
    }
    
    if (allJaps[naam]) {
        alert("‡§π‡•á ‡§ú‡§™ ‡§Ü‡§ß‡•Ä‡§ö ‡§Ü‡§π‡•á!");
        switchToJap(naam);
        input.value = "";
        cancelAddJap();
        return;
    }
    
    allJaps[naam] = { count: 0, todayTotal: 0, lifeTotal: 0 };
    currentNaam = naam;
    input.value = "";
    cancelAddJap();
    saveData();
    renderJapChips();
    updateUI();
}

// Switch to existing jap
function switchToJap(naam) {
    currentNaam = naam;
    saveData();
    renderJapChips();
    updateUI();
}

// Delete jap
function deleteJap(naam) {
    if (Object.keys(allJaps).length === 1) {
        alert("‡§ï‡§ø‡§Æ‡§æ‡§® ‡§è‡§ï ‡§ú‡§™ ‡§Ö‡§∏‡§£‡•á ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§Ü‡§π‡•á!");
        return;
    }
    
    delete allJaps[naam];
    
    if (currentNaam === naam) {
        currentNaam = Object.keys(allJaps)[0];
    }
    
    saveData();
    renderJapChips();
    updateUI();
}

// Show target info
function showTargetInfo() {
    const infoText = `
üéØ ‡§°‡•á‡§≤‡•Ä ‡§ü‡§æ‡§∞‡•ç‡§ó‡•á‡§ü ‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä:

üìå ‡§ü‡§æ‡§∞‡•ç‡§ó‡•á‡§ü ‡§ï‡§∏‡•á ‡§∏‡•á‡§ü ‡§ï‡§∞‡§æ‡§µ‡•á?
‚Ä¢ ‡§µ‡§∞‡•Ä‡§≤ ‡§¨‡•â‡§ï‡•ç‡§∏‡§Æ‡§ß‡•ç‡§Ø‡•á ‡§Æ‡§æ‡§≥‡§æ‡§Ç‡§ö‡•Ä ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ ‡§≤‡§ø‡§π‡§æ (‡§â‡§¶‡§æ. 11)
‚Ä¢ "‡§∏‡•á‡§µ‡•ç‡§π" ‡§¨‡§ü‡§® ‡§¶‡§æ‡§¨‡§æ

‚è∞ Notification ‡§µ‡•á‡§≥:
‚Ä¢ ‡§∏‡§ï‡§æ‡§≥‡•Ä ‡•≠ ‡§µ‡§æ‡§ú‡§≤‡•ç‡§Ø‡§æ‡§™‡§æ‡§∏‡•Ç‡§® ‡§∏‡•Å‡§∞‡•Å‡§µ‡§æ‡§§
‚Ä¢ ‡§™‡•ç‡§∞‡§§‡•ç‡§Ø‡•á‡§ï ‡•´ ‡§§‡§æ‡§∏‡§æ‡§Ç‡§®‡•Ä ‡§Ü‡§†‡§µ‡§£
‚Ä¢ ‡§µ‡•á‡§≥: ‡•≠, ‡•ß‡•®, ‡•ß‡•≠, ‡•®‡•ß ‡§µ‡§æ‡§ú‡§§‡§æ

üìä Progress Bar:
‚Ä¢ ‡§π‡§ø‡§∞‡§µ‡•ç‡§Ø‡§æ ‡§¨‡§æ‡§∞‡§Æ‡§ß‡•Ç‡§® progress ‡§¶‡§ø‡§∏‡•á‡§≤
‚Ä¢ ‡§ü‡§æ‡§∞‡•ç‡§ó‡•á‡§ü ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§ù‡§æ‡§≤‡•ç‡§Ø‡§æ‡§µ‡§∞ ‚úÖ ‡§¶‡§ø‡§∏‡•á‡§≤

üí° ‡§ü‡•Ä‡§™:
‚Ä¢ ‡§ü‡§æ‡§∞‡•ç‡§ó‡•á‡§ü ‡§∏‡•á‡§ü ‡§ï‡•á‡§≤‡•ç‡§Ø‡§æ‡§µ‡§∞‡§ö notification ‡§Ø‡•á‡§à‡§≤
‚Ä¢ ‡§ü‡§æ‡§∞‡•ç‡§ó‡•á‡§ü ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§ù‡§æ‡§≤‡•ç‡§Ø‡§æ‡§µ‡§∞ notification ‡§Ø‡•á‡§£‡§æ‡§∞ ‡§®‡§æ‡§π‡•Ä
    `;
    
    alert(infoText);
}

// Main increment
function increment(e) {
    if (!e) {
        // Direct call from button or volume
        doIncrement();
        return;
    }
    
    // Check if click is on interactive elements
    const target = e.target;
    if (target.tagName === 'INPUT' || 
        target.tagName === 'BUTTON' || 
        target.closest('.target-section') ||
        target.closest('.saved-japs-section') ||
        target.closest('.add-jap-box') ||
        target.closest('.button-group') ||
        target.closest('.jap-main-btn') ||
        target.closest('.modal')) {
        return;
    }

    doIncrement();
}

function doIncrement() {
    let currentVal = allJaps[currentNaam].count + 1;
    allJaps[currentNaam].todayTotal = (allJaps[currentNaam].todayTotal || 0) + 1;
    allJaps[currentNaam].lifeTotal = (allJaps[currentNaam].lifeTotal || 0) + 1;

    const countEl = document.getElementById("currentCount");
    countEl.classList.add("animate");
    setTimeout(() => countEl.classList.remove("animate"), 300);

    const beads = document.querySelectorAll(".bead");
    if (beads[currentVal - 1]) {
        beads[currentVal - 1].classList.add("pulse");
        setTimeout(() => beads[currentVal - 1].classList.remove("pulse"), 500);
    }

    if (currentVal >= 108) {
        playSound("complete");
        showMalaCompleteMessage();
        if (navigator.vibrate) navigator.vibrate([100, 50, 100, 50, 100]);
        currentVal = 0;
    } else {
        if (navigator.vibrate) navigator.vibrate(30);
    }

    allJaps[currentNaam].count = currentVal;
    saveData();
    renderJapChips();
    updateUI();
}

// Handle jap button click
function handleJapButtonClick(e) {
    if (e) e.stopPropagation();
    doIncrement();
}

// Update UI
function updateUI() {
    const count = allJaps[currentNaam].count;
    const currentTodayTotal = allJaps[currentNaam].todayTotal || 0;
    const currentLifeTotal = allJaps[currentNaam].lifeTotal || 0;
    const currentMalas = Math.floor(currentLifeTotal / 108);
    
    // Update center counter
    document.getElementById("currentCount").innerText = count;
    document.getElementById("currentNaamDisplay").innerText = currentNaam;
    
    // Update stats with current jap name
    document.getElementById("statLabel1").innerText = `‡§Æ‡§æ‡§≥‡§æ (${currentNaam})`;
    document.getElementById("statLabel2").innerText = `‡§Ü‡§ú‡§ö‡§æ ‡§ú‡§™ (${currentNaam})`;
    document.getElementById("statLabel3").innerText = `‡§è‡§ï‡•Ç‡§£ ‡§ú‡§™ (${currentNaam})`;
    
    document.getElementById("currentMalaCount").innerText = currentMalas;
    document.getElementById("currentTodayTotal").innerText = currentTodayTotal;
    document.getElementById("currentLifeTotal").innerText = currentLifeTotal;

    // Calculate total malas for target progress
    let totalTodayMalas = 0;
    for (let naam in allJaps) {
        totalTodayMalas += Math.floor((allJaps[naam].todayTotal || 0) / 108);
    }

    // Update modal progress if modal is open
    const modalProgressBar = document.getElementById("modalProgressBar");
    const modalTargetStatus = document.getElementById("modalTargetStatus");
    
    if (modalProgressBar && modalTargetStatus) {
        if (targetMalas > 0) {
            const progress = Math.min((totalTodayMalas / targetMalas) * 100, 100);
            modalProgressBar.style.width = progress + "%";
            
            let statusText = `${totalTodayMalas}/${targetMalas} ‡§Æ‡§æ‡§≥‡§æ`;
            if (targetJapName) {
                statusText += ` (${targetJapName})`;
            }
            if (totalTodayMalas >= targetMalas) {
                statusText = "‚úÖ ‡§Ü‡§ú‡§ö‡•á ‡§ü‡§æ‡§∞‡•ç‡§ó‡•á‡§ü ‡§™‡•Ç‡§∞‡•ç‡§£!";
            }
            modalTargetStatus.innerText = statusText;
        } else {
            modalProgressBar.style.width = "0%";
            modalTargetStatus.innerText = "Target ‡§∏‡•á‡§ü ‡§ï‡§∞‡§æ";
        }
    }

    const beads = document.querySelectorAll(".bead");
    beads.forEach((bead, index) => {
        bead.classList.toggle("active", index < count);
    });
}

// Volume button listener
let volumeListenerActive = false;

function setupVolumeListener() {
    if (volumeListenerActive) return;
    volumeListenerActive = true;
    
    document.addEventListener('keydown', function(e) {
        // Volume Up = 175, Volume Down = 174
        if (e.keyCode === 175 || e.keyCode === 174) {
            e.preventDefault();
            increment();
        }
    });
    
    // For mobile volume buttons
    let lastVolume = 0;
    if (typeof window !== 'undefined' && 'mediaDevices' in navigator) {
        try {
            const checkVolume = setInterval(() => {
                // This is a fallback method
                const currentTime = Date.now();
                if (window.volumeChangeTime && currentTime - window.volumeChangeTime < 500) {
                    increment();
                }
            }, 100);
        } catch (e) {
            console.log('Volume detection not available');
        }
    }
}

// Show target info
function showTargetInfo() {
    const infoText = `
üéØ ‡§°‡•á‡§≤‡•Ä ‡§ü‡§æ‡§∞‡•ç‡§ó‡•á‡§ü ‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä:

üìå ‡§ü‡§æ‡§∞‡•ç‡§ó‡•á‡§ü ‡§ï‡§∏‡•á ‡§∏‡•á‡§ü ‡§ï‡§∞‡§æ‡§µ‡•á?
‚Ä¢ ‡§µ‡§∞‡•Ä‡§≤ ‡§¨‡•â‡§ï‡•ç‡§∏‡§Æ‡§ß‡•ç‡§Ø‡•á ‡§Æ‡§æ‡§≥‡§æ‡§Ç‡§ö‡•Ä ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ ‡§≤‡§ø‡§π‡§æ (‡§â‡§¶‡§æ. 11)
‚Ä¢ "‡§∏‡•á‡§µ‡•ç‡§π" ‡§¨‡§ü‡§® ‡§¶‡§æ‡§¨‡§æ

‚è∞ Notification ‡§µ‡•á‡§≥:
‚Ä¢ ‡§∏‡§ï‡§æ‡§≥‡•Ä ‡•≠ ‡§µ‡§æ‡§ú‡§≤‡•ç‡§Ø‡§æ‡§™‡§æ‡§∏‡•Ç‡§® ‡§∏‡•Å‡§∞‡•Å‡§µ‡§æ‡§§
‚Ä¢ ‡§™‡•ç‡§∞‡§§‡•ç‡§Ø‡•á‡§ï ‡•´ ‡§§‡§æ‡§∏‡§æ‡§Ç‡§®‡•Ä ‡§Ü‡§†‡§µ‡§£
‚Ä¢ ‡§µ‡•á‡§≥: ‡•≠, ‡•ß‡•®, ‡•ß‡•≠, ‡•®‡•ß ‡§µ‡§æ‡§ú‡§§‡§æ

üìä Progress Bar:
‚Ä¢ ‡§π‡§ø‡§∞‡§µ‡•ç‡§Ø‡§æ ‡§¨‡§æ‡§∞‡§Æ‡§ß‡•Ç‡§® progress ‡§¶‡§ø‡§∏‡•á‡§≤
‚Ä¢ ‡§ü‡§æ‡§∞‡•ç‡§ó‡•á‡§ü ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§ù‡§æ‡§≤‡•ç‡§Ø‡§æ‡§µ‡§∞ ‚úÖ ‡§¶‡§ø‡§∏‡•á‡§≤

üí° ‡§ü‡•Ä‡§™:
‚Ä¢ ‡§ü‡§æ‡§∞‡•ç‡§ó‡•á‡§ü ‡§∏‡•á‡§ü ‡§ï‡•á‡§≤‡•ç‡§Ø‡§æ‡§µ‡§∞‡§ö notification ‡§Ø‡•á‡§à‡§≤
‚Ä¢ ‡§ü‡§æ‡§∞‡•ç‡§ó‡•á‡§ü ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§ù‡§æ‡§≤‡•ç‡§Ø‡§æ‡§µ‡§∞ notification ‡§Ø‡•á‡§£‡§æ‡§∞ ‡§®‡§æ‡§π‡•Ä
    `;
    
    alert(infoText);
}

// Show target settings modal
function showTargetSettings() {
    const modal = document.getElementById("targetModal");
    
    // Populate current values
    document.getElementById("targetMalaInput").value = targetMalas || "";
    document.getElementById("targetJapInput").value = targetJapName || "";
    
    // Render notification time chips
    renderNotificationTimes();
    
    // Update progress display in modal
    updateUI();
    
    modal.classList.add("show");
}

function closeTargetModal() {
    document.getElementById("targetModal").classList.remove("show");
}

// Render notification time selection
function renderNotificationTimes() {
    const container = document.getElementById("notificationTimes");
    const allTimes = [6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22];
    
    container.innerHTML = allTimes.map(hour => {
        const isSelected = selectedNotificationTimes.includes(hour);
        return `<div class="time-chip ${isSelected ? 'selected' : ''}" onclick="toggleNotificationTime(${hour})">
            ${hour}:00
        </div>`;
    }).join("");
}

function toggleNotificationTime(hour) {
    const index = selectedNotificationTimes.indexOf(hour);
    if (index > -1) {
        selectedNotificationTimes.splice(index, 1);
    } else {
        selectedNotificationTimes.push(hour);
    }
    selectedNotificationTimes.sort((a, b) => a - b);
    renderNotificationTimes();
}

// Save target settings
function saveTargetSettings() {
    const malaInput = parseInt(document.getElementById("targetMalaInput").value);
    const japInput = document.getElementById("targetJapInput").value.trim();
    
    if (!malaInput || malaInput < 1) {
        alert("‡§ï‡•É‡§™‡§Ø‡§æ ‡§ï‡§ø‡§Æ‡§æ‡§® 1 ‡§Æ‡§æ‡§≥‡§æ ‡§ü‡§æ‡§∞‡•ç‡§ó‡•á‡§ü ‡§≤‡§ø‡§π‡§æ!");
        return;
    }
    
    if (selectedNotificationTimes.length === 0) {
        alert("‡§ï‡•É‡§™‡§Ø‡§æ ‡§ï‡§ø‡§Æ‡§æ‡§® ‡§è‡§ï notification ‡§µ‡•á‡§≥ ‡§®‡§ø‡§µ‡§°‡§æ!");
        return;
    }
    
    targetMalas = malaInput;
    targetJapName = japInput;
    
    saveData();
    updateUI();
    setupNotifications();
    closeTargetModal();
    
    alert(`‚úÖ Target ‡§∏‡•á‡§µ‡•ç‡§π ‡§ù‡§æ‡§≤‡•á!\n\n${targetMalas} ‡§Æ‡§æ‡§≥‡§æ ${targetJapName ? '(' + targetJapName + ')' : ''}\n\nNotification: ${selectedNotificationTimes.map(h => h + ':00').join(', ')}`);
}

// Audio Jap functions
function showAudioJap() {
    const modal = document.getElementById("audioJapModal");
    renderAudioJapList();
    modal.classList.add("show");
}

function closeAudioJapModal() {
    document.getElementById("audioJapModal").classList.remove("show");
}

function renderAudioJapList() {
    const container = document.getElementById("audioJapList");
    container.innerHTML = "";
    
    for (let naam in audioJaps) {
        const item = document.createElement("div");
        item.className = "audio-jap-item";
        
        const info = document.createElement("div");
        info.className = "audio-jap-info";
        
        const nameDiv = document.createElement("div");
        nameDiv.className = "audio-jap-name";
        nameDiv.textContent = naam;
        
        const countDiv = document.createElement("div");
        countDiv.className = "audio-jap-count";
        countDiv.textContent = `‡§ú‡§™: ${audioJaps[naam].count}`;
        
        info.appendChild(nameDiv);
        info.appendChild(countDiv);
        
        const playBtn = document.createElement("button");
        playBtn.className = "audio-play-btn" + (audioJaps[naam].playing ? " playing" : "");
        playBtn.textContent = audioJaps[naam].playing ? "‚è∏" : "‚ñ∂";
        playBtn.onclick = () => toggleAudioJap(naam);
        
        item.appendChild(info);
        item.appendChild(playBtn);
        container.appendChild(item);
    }
}

function toggleAudioJap(naam) {
    // Stop any currently playing audio
    if (currentAudio && currentAudio !== naam) {
        stopAudioJap(currentAudio);
    }
    
    if (audioJaps[naam].playing) {
        stopAudioJap(naam);
    } else {
        startAudioJap(naam);
    }
}

function startAudioJap(naam) {
    // Create audio element if not exists
    if (!currentAudio || currentAudio !== naam) {
        const audio = new Audio(audioJaps[naam].url);
        audio.loop = true;
        audio.play().catch(e => console.log("Audio play error:", e));
        window.currentAudioElement = audio;
    }
    
    audioJaps[naam].playing = true;
    currentAudio = naam;
    
    // Start counting - every 5 seconds increment
    audioCountInterval = setInterval(() => {
        if (audioJaps[naam].playing) {
            audioJaps[naam].count++;
            saveData();
            renderAudioJapList();
        }
    }, 5000); // 5 seconds per jap
    
    // Keep screen awake
    if ('wakeLock' in navigator) {
        navigator.wakeLock.request('screen').catch(e => console.log("Wake lock error:", e));
    }
    
    renderAudioJapList();
}

function stopAudioJap(naam) {
    if (window.currentAudioElement) {
        window.currentAudioElement.pause();
        window.currentAudioElement = null;
    }
    
    audioJaps[naam].playing = false;
    currentAudio = null;
    
    if (audioCountInterval) {
        clearInterval(audioCountInterval);
        audioCountInterval = null;
    }
    
    saveData();
    renderAudioJapList();
}

// Reset today
function resetToday() {
    if (confirm("‡§Ü‡§ú‡§ö‡§æ ‡§∏‡§Ç‡§™‡•Ç‡§∞‡•ç‡§£ ‡§ú‡§™ ‡§∞‡§ø‡§∏‡•á‡§ü ‡§ï‡§∞‡§æ‡§Ø‡§ö‡§æ ‡§ï‡§æ?")) {
        todayTotal = 0;
        for (let naam in allJaps) {
            allJaps[naam].count = 0;
            allJaps[naam].todayCount = 0;
        }
        saveData();
        renderJapChips();
        updateUI();
    }
}

// Show history
function showHistory() {
    const modal = document.getElementById("historyModal");
    const content = document.getElementById("historyContent");
    
    if (history.length === 0) {
        content.innerHTML = "<p style='text-align: center; opacity: 0.7;'>‡§Ö‡§ú‡•Ç‡§® ‡§á‡§§‡§ø‡§π‡§æ‡§∏ ‡§®‡§æ‡§π‡•Ä</p>";
    } else {
        content.innerHTML = history.map(day => {
            let japsHtml = "";
            for (let naam in day.japs) {
                japsHtml += `
                    <div class="history-jap-entry">
                        <strong>${naam}:</strong> ${day.japs[naam].count} ‡§ú‡§™ | ${day.japs[naam].malas} ‡§Æ‡§æ‡§≥‡§æ
                    </div>
                `;
            }
            return `
                <div class="history-item">
                    <div class="history-date">${day.date}</div>
                    ${japsHtml}
                </div>
            `;
        }).join("");
    }
    
    modal.classList.add("show");
}

function closeHistory() {
    document.getElementById("historyModal").classList.remove("show");
}

// Mala complete message
function showMalaCompleteMessage() {
    const msg = document.createElement("div");
    msg.innerHTML = `üéâ ${currentNaam} - ‡§è‡§ï ‡§Æ‡§æ‡§≥‡§æ ‡§™‡•Ç‡§∞‡•ç‡§£! üôè`;
    msg.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(135deg, #FFD700, #FFA500);
        color: #000;
        padding: 20px 40px;
        border-radius: 15px;
        font-size: 24px;
        font-weight: 900;
        z-index: 2000;
        box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        animation: fadeInOut 2s ease;
    `;
    document.body.appendChild(msg);
    setTimeout(() => msg.remove(), 2000);
}

function playSound(type) {
    const audio = new Audio();
    if (type === "complete") {
        audio.src = "https://www.soundjay.com/misc/sounds/bell-ringing-05.mp3";
    }
    audio.play().catch(() => {});
}

// Notification system
function requestNotificationPermission() {
    if ("Notification" in window && Notification.permission === "default") {
        Notification.requestPermission();
    }
}

function setupNotifications() {
    if (!targetMalas || targetMalas === 0) return;
    
    notificationSchedule = selectedNotificationTimes;
    saveData();
    checkNotifications();
}

function checkNotifications() {
    setInterval(() => {
        if (!targetMalas || targetMalas === 0) return;
        
        const now = new Date();
        const currentHour = now.getHours();
        const currentMinute = now.getMinutes();
        
        if (currentMinute === 0 && notificationSchedule.includes(currentHour)) {
            let totalTodayMalas = 0;
            for (let naam in allJaps) {
                totalTodayMalas += Math.floor((allJaps[naam].todayTotal || 0) / 108);
            }
            
            if (totalTodayMalas < targetMalas && Notification.permission === "granted") {
                let notificationBody = `‡§Ü‡§ú‡§ö‡•á ${targetMalas - totalTodayMalas} ‡§Æ‡§æ‡§≥‡§æ ‡§Ö‡§ú‡•Ç‡§® ‡§¨‡§æ‡§ï‡•Ä ‡§Ü‡§π‡•á‡§§!`;
                if (targetJapName) {
                    notificationBody = `${targetJapName} - ` + notificationBody;
                }
                notificationBody += `\n‚è∞ ‡§™‡•Å‡§¢‡•Ä‡§≤ ‡§Ü‡§†‡§µ‡§£: ${getNextNotificationTime(currentHour)}`;
                
                new Notification("üôè ‡§®‡§æ‡§Æ ‡§ú‡§™ ‡§Ü‡§†‡§µ‡§£", {
                    body: notificationBody,
                    icon: "https://cdn-icons-png.flaticon.com/512/2850/2850812.png",
                    requireInteraction: false
                });
            }
        }
    }, 60000);
}

function getNextNotificationTime(currentHour) {
    const nextTime = notificationSchedule.find(h => h > currentHour);
    if (nextTime) {
        return nextTime + ":00 ‡§µ‡§æ‡§ú‡§§‡§æ";
    } else if (notificationSchedule.length > 0) {
        return "‡§â‡§¶‡•ç‡§Ø‡§æ " + notificationSchedule[0] + ":00 ‡§µ‡§æ‡§ú‡§§‡§æ";
    }
    return "‡§Ü‡§ú‡§ö‡•á notifications ‡§∏‡§Ç‡§™‡§≤‡•á";
}

const style = document.createElement("style");
style.textContent = `
    @keyframes fadeInOut {
        0%, 100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
        10%, 90% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
    }
`;
document.head.appendChild(style);

init();
</script>
</body>
</html>
