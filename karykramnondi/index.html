<!DOCTYPE html>
<html lang="mr">
<head>
<meta charset="UTF-8">
<title>‡§™‡•Ç‡§ú‡§æ ‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡§∞ - Ultimate</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
/* ---------- FIREBASE INIT ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyCNF-MyRZjVJ7caQbwFMWrb5cbJKPLvu5E",
  authDomain: "om-karmyog.firebaseapp.com",
  projectId: "om-karmyog",
  storageBucket: "om-karmyog.firebasestorage.app",
  messagingSenderId: "115489306172",
  appId: "1:115489306172:web:44ba73f0722d4208347539"
};

firebase.initializeApp(firebaseConfig);
const messaging = firebase.messaging();
const db = firebase.firestore();

/* ---------- SERVICE WORKER ---------- */
navigator.serviceWorker.register('firebase-messaging-sw.js')
.then(reg => messaging.useServiceWorker(reg));

/* ---------- REQUEST PERMISSION ---------- */
function requestPermission(){
 Notification.requestPermission().then(permission=>{
   if(permission === "granted"){
     messaging.getToken({
       vapidKey:"BKuAu4hhs0jc_il0_al9vAp1iW2icNIW8jSK1rm5C-qTM4Hj-rkKpx3St_AtlsDVImXv_3UqEn1Nk2LElgZ994s"
     }).then(token=>{
        localStorage.setItem("fcm_token", token);
        console.log("‚úÖ FCM Token:", token);

        // Enable Save Button after token ready
        document.getElementById("saveBtn").disabled = false;
     });
   } else {
     alert("üîî Notification permission allow ‡§ï‡§∞‡§æ");
   }
 });
}
requestPermission();


/* ---------- SAVE REMINDER TO FIRESTORE ---------- */
function saveReminderToCloud(entry){
 const token = localStorage.getItem("fcm_token");
 if(!token){
   alert("Token not ready yet. Page reload ‡§ï‡§∞‡§æ.");
   return;
 }

 // Same Day
 if(entry.reminders.same){
   db.collection("reminders").add({
     token: token,
     time: entry.date + "T" + entry.reminders.sameTime + ":00",
     title: "üîî ‡§™‡•Ç‡§ú‡§æ ‡§Ü‡§†‡§µ‡§£",
     body: entry.pooja + " ‡§Ü‡§ú ‡§Ü‡§π‡•á"
   });
 }

 // One Day Before
 if(entry.reminders.before){
   const d = new Date(entry.date);
   d.setDate(d.getDate()-1);
   const day = d.toISOString().split("T")[0];

   db.collection("reminders").add({
     token: token,
     time: day + "T" + entry.reminders.beforeTime + ":00",
     title: "üîî ‡§â‡§¶‡•ç‡§Ø‡§æ‡§ö‡•Ä ‡§™‡•Ç‡§ú‡§æ",
     body: entry.pooja + " ‡§â‡§¶‡•ç‡§Ø‡§æ ‡§Ü‡§π‡•á"
   });
 }

 // Custom
 if(entry.reminders.custom && entry.reminders.customTime){
   db.collection("reminders").add({
     token: token,
     time: entry.reminders.customTime + ":00",
     title: "üîî Custom Reminder",
     body: entry.pooja + " ‡§Ü‡§†‡§µ‡§£"
   });
 }

 console.log("‚úÖ Reminder Saved in Firestore");
}
</script>

<style>
body{font-family:Poppins;margin:0;background:#f7f2ed;color:#2b0000;}
.app-header{background:#8b0000;color:#ffd700;padding:14px;text-align:center;font-size:20px;font-weight:bold;}
.container{padding:15px;}
.card{background:#fff;padding:15px;margin:10px 0;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.1);}
.primary-btn{background:#8b0000;color:#ffd700;border:none;padding:12px;width:100%;border-radius:8px;font-weight:bold;}
.primary-btn:disabled{background:#999;}
input{width:100%;padding:10px;margin:6px 0;border:1px solid #ccc;border-radius:6px;}
.reminder-item{display:flex;justify-content:space-between;margin:6px 0;}
</style>
</head>

<body>

<div class="app-header">‚ú® ‡§™‡•Ç‡§ú‡§æ ‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡§∞</div>

<div class="container">

<div class="card">

<label>‡§™‡•Ç‡§ú‡§æ ‡§®‡§æ‡§µ *</label>
<input id="pooja">

<label>‡§§‡§æ‡§∞‡•Ä‡§ñ *</label>
<input type="date" id="date">

<label>‡§Ø‡§ú‡§Æ‡§æ‡§® *</label>
<input id="yajman">

<label>‡§¶‡§ï‡•ç‡§∑‡§ø‡§£‡§æ</label>
<input type="number" id="dakshina">

<hr>
<b>üîî Reminder ‡§∏‡•á‡§ü ‡§ï‡§∞‡§æ</b>

<div class="reminder-item">
 <span>‡§§‡•ç‡§Ø‡§æ‡§ö ‡§¶‡§ø‡§µ‡§∂‡•Ä</span>
 <input type="checkbox" id="remSame">
 <input type="time" id="remSameTime" value="08:00">
</div>

<div class="reminder-item">
 <span>‡§è‡§ï ‡§¶‡§ø‡§µ‡§∏ ‡§Ü‡§ß‡•Ä</span>
 <input type="checkbox" id="remBefore">
 <input type="time" id="remBeforeTime" value="18:00">
</div>

<div class="reminder-item">
 <span>Custom</span>
 <input type="checkbox" id="remCustom">
 <input type="datetime-local" id="remCustomTime">
</div>

<button class="primary-btn" id="saveBtn" onclick="saveEntry()" disabled>üíæ ‡§∏‡•á‡§µ‡•ç‡§π</button>

</div>
</div>

<script>
let data=[];

function saveEntry(){

 const entry = {
   id: Date.now(),
   pooja: document.getElementById("pooja").value.trim(),
   date: document.getElementById("date").value,
   yajman: document.getElementById("yajman").value.trim(),
   dakshina: Number(document.getElementById("dakshina").value||0),
   reminders:{
     same: document.getElementById("remSame").checked,
     sameTime: document.getElementById("remSameTime").value,
     before: document.getElementById("remBefore").checked,
     beforeTime: document.getElementById("remBeforeTime").value,
     custom: document.getElementById("remCustom").checked,
     customTime: document.getElementById("remCustomTime").value
   }
 };

 // Validation
 if(!entry.pooja || !entry.date || !entry.yajman){
   alert("‚ö†Ô∏è ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•Ç‡§ú‡§æ ‡§®‡§æ‡§µ, ‡§§‡§æ‡§∞‡•Ä‡§ñ ‡§Ü‡§£‡§ø ‡§Ø‡§ú‡§Æ‡§æ‡§® ‡§≠‡§∞‡§æ");
   return;
 }

 data.push(entry);
 localStorage.setItem("poojaRegisterData", JSON.stringify(data));

 // Save to Firestore Cloud
 saveReminderToCloud(entry);

 alert("‚úÖ ‡§®‡•ã‡§Ç‡§¶ ‡§∏‡•á‡§µ‡•ç‡§π ‡§ù‡§æ‡§≤‡•Ä ‡§Ü‡§£‡§ø Reminder Cloud ‡§≤‡§æ ‡§ó‡•á‡§≤‡§æ!");

 // Reset form
 document.getElementById("pooja").value="";
 document.getElementById("date").value="";
 document.getElementById("yajman").value="";
 document.getElementById("dakshina").value="";
}
</script>

</body>
</html>
